# 如何验证 Jetson 硬件编码是否正在使用

## 📋 快速验证方法

现在启动程序后，日志会**明确显示**是否使用了硬件编码。

### 预期的日志输出

#### ✅ 如果硬件编码**成功启用**，您会看到：

```
2025-10-07 15:37:58 - __main__ - INFO - Starting RealSense D435 WebRTC Streamer with MQTT...
2025-10-07 15:37:58 - __main__ - INFO - ✅ Hardware encoder 'h264_nvenc' is available on this system
2025-10-07 15:37:58 - __main__ - INFO - ✅ Hardware encoder configuration applied (will activate on first encode)
...
[WebRTC 连接建立后，首次编码时]
2025-10-07 15:38:22 - __main__ - INFO - ============================================================
2025-10-07 15:38:22 - __main__ - INFO - 🚀 HARDWARE ENCODER ACTIVATED!
2025-10-07 15:38:22 - __main__ - INFO -    Encoder: h264_nvenc (NVIDIA NVENC)
2025-10-07 15:38:22 - __main__ - INFO -    Replaced: libx264 -> h264_nvenc
2025-10-07 15:38:22 - __main__ - INFO -    Bitrate: 6000 kbps
2025-10-07 15:38:22 - __main__ - INFO -    Preset: P1 (fastest, low latency)
2025-10-07 15:38:22 - __main__ - INFO - ============================================================
```

**关键标志：** 看到 `🚀 HARDWARE ENCODER ACTIVATED!` 就表示硬件编码已成功启用！

#### ❌ 如果硬件编码**不可用**，您会看到：

```
2025-10-07 15:37:58 - __main__ - ERROR - ❌ Hardware encoder 'h264_nvenc' is NOT available: ...
2025-10-07 15:37:58 - __main__ - ERROR -    Falling back to software encoder
2025-10-07 15:37:58 - __main__ - ERROR -    Check: 1) Jetson-FFmpeg installation  2) FFmpeg NVENC support
```

---

## 🔍 实时监控工具

### 方法1：使用监控脚本（推荐）

运行专门的监控脚本：

```bash
# 单次检查
sudo ./monitor_nvenc.sh

# 实时监控模式（每10秒刷新）
sudo ./monitor_nvenc.sh --loop
```

这个脚本会检查：
- ✅ 进程是否加载了 NVENC 库
- ✅ CPU 使用率（硬件编码 <30%，软件编码 >60%）
- ✅ Jetson NVENC 引擎状态
- ✅ FFmpeg NVENC 支持

### 方法2：使用 tegrastats（最直接）

这是**最可靠**的方法，直接查看 Jetson 硬件状态：

```bash
sudo tegrastats
```

**查看输出中的 NVENC 字段：**

```
RAM 3045/7471MB (lfb 50x4MB) SWAP 0/3735MB ... NVENC 450 ...
                                                  ^^^^
                                           这个值 > 0 表示使用中
```

- **NVENC > 0** → ✅ 硬件编码器正在使用
- **NVENC = 0** 或 **没有 NVENC 字段** → ❌ 未使用硬件编码

### 方法3：查看 CPU 使用率

```bash
# 查看 Python 进程的 CPU 使用率
top -p $(pgrep -f realsenseD435)
```

**CPU 使用率对比：**

| 编码方式 | CPU 使用率 | 说明 |
|---------|-----------|------|
| 🟢 硬件编码 | **10-30%** | NVENC 硬件加速 |
| 🔴 软件编码 | **60-90%** | libx264 CPU 编码 |

### 方法4：检查加载的库

```bash
# 查看进程加载的 NVIDIA 库
PID=$(pgrep -f realsenseD435)
sudo lsof -p $PID | grep -E "nvidia-encode|nvenc"
```

如果看到类似输出，说明使用了硬件编码：
```
python3  12345  nvidia  mem  REG  /usr/lib/aarch64-linux-gnu/libnvidia-encode.so.1
```

---

## 🧪 测试硬件编码器可用性

### 🔍 首先运行完整检测（重要！）

**在 Jetson 设备上，先运行这个检测脚本：**

```bash
python3 detect_jetson_encoders.py
```

这个脚本会全面检测：
- ✅ FFmpeg 支持的所有 H.264 编码器
- ✅ PyAV 能实际使用的编码器（**最关键**）
- ✅ GStreamer 硬件编码插件
- ✅ Jetson Multimedia API 库
- ✅ Jetson-FFmpeg 安装状态
- ✅ 自动生成推荐配置

**根据检测结果，脚本会告诉您：**
1. 哪些硬件编码器可用
2. 推荐的编码器优先级
3. 如何配置 `realsenseD435.py`

### 基础性能测试（可选）

```bash
python3 test_hardware_encoder.py
```

这会告诉您：
- ✅ 系统中哪些 H.264 编码器可用
- ✅ 硬件编码性能（帧率、码率）
- ✅ FFmpeg 配置是否正确

---

## 📊 性能对比参考

### 硬件编码 (h264_nvenc) - 预期表现

```
✅ CPU 使用率: 15-25%
✅ 编码延迟: 15-30 ms
✅ 稳定帧率: 30 fps @ 1080p
✅ 温度: 较低
```

### 软件编码 (libx264) - 预期表现

```
❌ CPU 使用率: 70-85%
❌ 编码延迟: 50-80 ms
❌ 帧率波动: 可能掉帧
❌ 温度: 较高
```

---

## ⚠️ 故障排除

### 如果没有看到 "🚀 HARDWARE ENCODER ACTIVATED!"

**可能原因1**: WebRTC 连接尚未建立

- 硬件编码器在**首次编码时**才激活
- 请等待浏览器连接后再查看日志

**可能原因2**: Jetson-FFmpeg 未正确安装

```bash
# 检查 FFmpeg 是否支持 NVENC
ffmpeg -encoders | grep nvenc

# 如果没有输出，需要重新安装 Jetson-FFmpeg
# 参考: https://github.com/jocover/jetson-ffmpeg
```

**可能原因3**: NVENC 库缺失

```bash
# 检查 NVENC 库
ls -la /usr/lib/aarch64-linux-gnu/libnvidia-encode.so*

# 如果不存在，可能需要更新 JetPack 或驱动
```

### 临时切换到软件编码

如果需要对比或调试，可以临时禁用硬件编码：

```python
# 在 realsenseD435.py 中修改
ENABLE_HARDWARE_ENCODING = False  # 改为 False
```

---

## 🎯 总结：判断标准

| 检查项 | 硬件编码 | 软件编码 |
|-------|---------|---------|
| 启动日志 | 显示 "🚀 HARDWARE ENCODER ACTIVATED!" | 无此日志 |
| tegrastats | NVENC > 0 | NVENC = 0 |
| CPU 使用率 | < 30% | > 60% |
| 加载的库 | libnvidia-encode.so | 无 NVIDIA 库 |

**只要看到启动日志中的 "🚀 HARDWARE ENCODER ACTIVATED!" 就可以确认硬件编码已成功使用！**

---

## 📞 需要帮助？

如果仍然不确定，请提供以下信息：

1. 完整的启动日志
2. `tegrastats` 输出（运行中）
3. `ffmpeg -encoders | grep nvenc` 的输出
4. CPU 使用率截图

---

**最后更新**: 2025-10-07

