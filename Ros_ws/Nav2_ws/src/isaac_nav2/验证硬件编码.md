# 验证 h264_v4l2m2m 硬件编码是否工作

## 🎉 好消息！

您的程序已经成功检测并选择了 **h264_v4l2m2m** 硬件编码器！

```
✅ Hardware encoder 'h264_v4l2m2m' is available
🎯 Selected hardware encoder: h264_v4l2m2m
```

## 📋 验证步骤

### 步骤 1：连接浏览器查看激活日志

硬件编码器会在 **WebRTC 连接建立并开始传输时** 激活。

1. 打开浏览器访问 WebRTC 页面
2. 建立连接
3. 查看程序日志，应该看到：

```
============================================================
🚀 HARDWARE ENCODER ACTIVATED!
   Encoder: h264_v4l2m2m
   Replaced: libx264 -> h264_v4l2m2m
   Bitrate: 6000 kbps
   Platform: Jetson (Hardware Accelerated)
============================================================
```

**看到这个消息 = 硬件编码确认工作！** ✅

---

### 步骤 2：监控 CPU 使用率（最可靠）

#### 方法 A：使用自动监控脚本（推荐）

在 Jetson 上新开一个终端：

```bash
sudo ./monitor_encoding.sh
```

这个脚本会自动显示：
- ✅ CPU 使用率（实时）
- ✅ 编码状态判断
- ✅ V4L2 设备使用情况
- ✅ 是否使用硬件编码

#### 方法 B：手动查看 CPU

```bash
# 方法 1: 使用 top
top -p $(pgrep -f realsenseD435)

# 方法 2: 使用 htop（更友好）
htop -p $(pgrep -f realsenseD435)
```

**判断标准：**

| CPU 使用率 | 编码方式 | 状态 |
|-----------|---------|------|
| **15-35%** | 🟢 h264_v4l2m2m | ✅ 硬件编码工作 |
| **40-55%** | 🟡 混合 | ⚠️ 部分硬件加速 |
| **60-85%** | 🔴 libx264 | ❌ 软件编码 |

---

### 步骤 3：使用 tegrastats 查看系统状态

```bash
sudo tegrastats
```

**硬件编码的特征：**
- CPU 各核心使用率相对较低（< 40%）
- 整体系统负载较低
- 可能看到 VIC 或其他引擎活动

示例输出：
```
CPU [25%@729,22%@729,28%@729,24%@729,26%@729,23%@729]  ← 都比较低
```

---

### 步骤 4：检查 V4L2 设备

```bash
# 查看进程打开的设备
sudo lsof -p $(pgrep -f realsenseD435) | grep video
```

如果使用了 h264_v4l2m2m，可能会看到类似：
```
python3  12345  nvidia  mem  REG  /dev/video0
python3  12345  nvidia  mem  REG  /dev/video1
```

---

## 📊 性能对比

### 预期性能（1280x720@15fps）

| 指标 | 软件编码 | h264_v4l2m2m |
|------|---------|--------------|
| CPU 使用率 | 70-80% | **20-35%** ✅ |
| 编码延迟 | 50-70ms | **25-40ms** ✅ |
| 温度 | 较高 | **较低** ✅ |
| 功耗 | 6-8W | **5-7W** ✅ |

---

## ✅ 验证清单

完成以下检查以确认硬件编码：

- [ ] 程序启动时看到 "✅ Hardware encoder 'h264_v4l2m2m' is available"
- [ ] 浏览器连接后看到 "🚀 HARDWARE ENCODER ACTIVATED!"
- [ ] CPU 使用率 < 35%
- [ ] tegrastats 显示 CPU 各核心负载较低
- [ ] （可选）lsof 显示使用了 /dev/video 设备

**如果完成 2-3 项，就可以确认硬件编码在工作！**

---

## 🔧 故障排除

### 如果 CPU 使用率仍然很高（> 60%）

**可能原因：**

1. **硬件编码器配置失败**
   - 查看程序完整日志
   - 应该有错误信息或回退到软件编码的提示

2. **WebRTC 连接未建立**
   - 硬件编码器只在实际传输时工作
   - 确保浏览器已连接

3. **V4L2 编码器性能限制**
   - h264_v4l2m2m 可能不如 nvenc 高效
   - 但仍比软件编码好很多

### 如果没有看到激活日志

**检查：**

```bash
# 查看完整日志
python3 realsenseD435.py 2>&1 | tee full.log

# 然后搜索：
grep -i "hardware\|encoder\|activated" full.log
```

---

## 📈 实时监控命令速查

```bash
# 1. 自动监控（推荐）
sudo ./monitor_encoding.sh

# 2. CPU 监控
top -p $(pgrep -f realsenseD435)

# 3. 系统状态
sudo tegrastats

# 4. 设备使用
sudo lsof -p $(pgrep -f realsenseD435) | grep video

# 5. 进程资源使用
ps aux | grep realsenseD435
```

---

## 🎯 快速测试

**5 秒快速验证：**

1. 确保程序正在运行且浏览器已连接
2. 运行: `top -p $(pgrep -f realsenseD435)` 
3. 查看 CPU 列（%CPU）
4. 如果 < 40% → ✅ 硬件编码
5. 如果 > 65% → ❌ 软件编码

---

## 💡 提示

- **首次连接可能 CPU 会短暂升高**（初始化），等待 5-10 秒再判断
- **如果有多个浏览器连接**，CPU 使用率会相应增加
- **RealSense 相机本身**也会占用一些 CPU（约 5-10%）
- **h264_v4l2m2m 不如 nvenc**，但比软件编码好得多

---

**祝您监控顺利！** 🚀

有任何问题，检查日志中的 "🚀 HARDWARE ENCODER ACTIVATED!" 消息。

